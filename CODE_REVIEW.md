# Code Review: Lesson + Card Logic

Ниже — фокусированный обзор логики уроков/карточек и наполнения (Lesson Player/Preview, загрузка `lesson_items`, обработка квизов и карточек).

## Резюме

Основные риски находятся в нормализации контента (типов и формата данных) и в обработке квиз‑опций: часть кода предполагает строковые варианты, но не всегда корректно работает с объектами. Это может ломать логику прохождения уроков и начисление прогресса при разных форматах данных.

## Ключевые замечания

### 1) Несогласованная обработка типов уроков (case‑sensitive)

В `useLessonPlayer` логика автодоступа кнопки «Далее» использует тип без нормализации (`items[step]?.type`). Если в данных тип приходит как `Theory`, `Quiz`, `Vocab_Card` и т.д., то авторазблокировка может не сработать. В `LessonPlayer` тип уже нормализуется (`toLowerCase()`), но это не распространяется на `LessonPreview`, где нет своей нормализации и используется состояние `canAdvance` из хука.

**Где:** авторазблокировка в `useLessonPlayer` использует `items[step]?.type` без `toLowerCase()`.【F:khmer-mastery/src/hooks/useLessonPlayer.js†L104-L131】

### 2) В LessonPreview квиз‑ответы передаются как объекты, но хук сравнивает строки

`handleQuizAnswer` в хуке приводит ответ к строке через `String(option)`, и сравнивает с `String(correctAnswer)`. В `LessonPreview` при клике передается `opt` (может быть объект), из-за чего сравнение становится `"[object Object]"` и корректные ответы не распознаются. В `LessonPlayer` это решено — туда передают `rawValue` (строку).

**Где:** `LessonPreview` передает `opt` напрямую.【F:khmer-mastery/src/pages/LessonPreview.jsx†L163-L181】

**Где:** сравнение в `handleQuizAnswer` строковое, без нормализации структуры.【F:khmer-mastery/src/hooks/useLessonPlayer.js†L255-L272】

### 3) Нормализация quiz‑опций не учитывает объектные варианты

В `useLessonPlayer` при подготовке quiz‑контента:
- `options` может быть массивом объектов (с `text`, `value` и т.д.),
- `correct_answer` может быть строкой или объектом,
- сравнение `mergedOptions.includes(correctAnswer)` не сработает при разных типах (объекты/строки),
- итоговый `options` может стать «смешанным» (объекты + строка).

Это может приводить к ситуации, когда правильный ответ всегда добавляется как строка и не совпадает с объектными опциями в UI.

**Где:** логика формирования `options` в нормализации урока.【F:khmer-mastery/src/hooks/useLessonPlayer.js†L106-L132】

### 4) Подсчет `quizCount` чувствителен к регистру типов

`quizCount` считается по `type === 'quiz'` еще до нормализации регистра. Если тип приходит как `Quiz`, `QUIZ` и т.д., счетчик будет нулевым, а урок может считаться «пройденным» без тестов.

**Где:** установка `quizCount` без `toLowerCase()`.【F:khmer-mastery/src/hooks/useLessonPlayer.js†L134-L141】

### 5) Логика “English/Khmer side” опирается только на `front/back` и регулярку

В `LessonPlayer` определение English/Khmer сторон опирается только на `front`/`back` и наличие кхмерских символов. Если обе стороны содержат кхмерские символы (или обе латиницу), карточка может показать «английскую» сторону не туда, где ожидается.

**Где:** вычисление `englishText`/`khmerText` в `LessonPlayer`.【F:khmer-mastery/src/pages/LessonPlayer.jsx†L163-L173】

## Дополнительные рекомендации

- Вынести единый нормализатор типов (lowercase) в `useLessonPlayer` и применять его до всех проверок и подсчетов.
- Для quiz‑ответов привести опции и `correct_answer` к единому формату (`{ value, text, audio }`) и сравнивать по `value`.
- Для `LessonPreview` и `LessonPlayer` использовать одинаковую стратегию передачи ответов (строки vs объекты).
- Добавить небольшие интеграционные тесты на:
  - mixed format options (strings + objects),
  - неверный регистр типов,
  - корректное сохранение прохождения при наличии quiz.
